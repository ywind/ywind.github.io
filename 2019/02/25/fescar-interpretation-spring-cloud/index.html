<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Java,Spring Cloud,Distributed Transaction,Fescar," />





  <link rel="alternate" href="/atom.xml" title="风吟无声" type="application/atom+xml" />






<meta name="description" content="最近一直在了解学习分布式事务相关的内容，恰好阿里开源了GTS的开源实现 Fescar 。阿里的背书是Java届非常认可的，所以项目本身短短时间便收到了将近6k的star ⭐。抱着学习的心态对它的原理进行了解，同时因为我们现在的微服务框架采用的是Spring Cloud，所以也分析下Fescar 整合Spring Cloud部分的源码机制。">
<meta name="keywords" content="Java,Spring Cloud,Distributed Transaction,Fescar">
<meta property="og:type" content="article">
<meta property="og:title" content="Fescar在SpringCloud中事务传播源码分析">
<meta property="og:url" content="https://icoding.live/2019/02/25/fescar-interpretation-spring-cloud/index.html">
<meta property="og:site_name" content="风吟无声">
<meta property="og:description" content="最近一直在了解学习分布式事务相关的内容，恰好阿里开源了GTS的开源实现 Fescar 。阿里的背书是Java届非常认可的，所以项目本身短短时间便收到了将近6k的star ⭐。抱着学习的心态对它的原理进行了解，同时因为我们现在的微服务框架采用的是Spring Cloud，所以也分析下Fescar 整合Spring Cloud部分的源码机制。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://camo.githubusercontent.com/6a31d57b4496e83af1a0bd76ede83657de2d9d34/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f343432303736372d343934613534643430326232643335342e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430">
<meta property="og:updated_time" content="2019-03-03T10:05:18.261Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fescar在SpringCloud中事务传播源码分析">
<meta name="twitter:description" content="最近一直在了解学习分布式事务相关的内容，恰好阿里开源了GTS的开源实现 Fescar 。阿里的背书是Java届非常认可的，所以项目本身短短时间便收到了将近6k的star ⭐。抱着学习的心态对它的原理进行了解，同时因为我们现在的微服务框架采用的是Spring Cloud，所以也分析下Fescar 整合Spring Cloud部分的源码机制。">
<meta name="twitter:image" content="https://camo.githubusercontent.com/6a31d57b4496e83af1a0bd76ede83657de2d9d34/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f343432303736372d343934613534643430326232643335342e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://icoding.live/2019/02/25/fescar-interpretation-spring-cloud/"/>





  <title>Fescar在SpringCloud中事务传播源码分析 | 风吟无声</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">风吟无声</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-rss"></i> <br />
            
            rss
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://icoding.live/2019/02/25/fescar-interpretation-spring-cloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShukangGuo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/7402027?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="风吟无声">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Fescar在SpringCloud中事务传播源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T19:05:46+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/02/25/fescar-interpretation-spring-cloud/" class="leancloud_visitors" data-flag-title="Fescar在SpringCloud中事务传播源码分析">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>最近一直在了解学习分布式事务相关的内容，恰好阿里开源了GTS的开源实现 <a href="https://github.com/alibaba/fescar/" target="_blank" rel="noopener">Fescar</a> 。阿里的背书是Java届非常认可的，所以项目本身短短时间便收到了将近6k的star ⭐。抱着学习的心态对它的原理进行了解，同时因为我们现在的微服务框架采用的是Spring Cloud，所以也分析下Fescar 整合Spring Cloud部分的源码机制。 </p>
<a id="more"></a>
<h3 id="Fescar简要介绍"><a href="#Fescar简要介绍" class="headerlink" title="Fescar简要介绍"></a>Fescar简要介绍</h3><p>常见的分布式事务方式有基于2PC的XA (e.g. atomikos)，从业务层入手的TCC( e.g. byteTCC)、事务消息( e.g. RocketMQ Half Message)等等。XA是需要本地数据库支持的分布式事务的协议，资源锁在数据库层面导致性能较差，而支付宝作为布道师引入的TCC模式需要大量的业务代码保证，开发维护成本较高。</p>
<p>分布式事务是业界比较关注的领域，这也是短短时间Fescar能收获6k Star的原因之一。Fescar 名字取自 <strong>Fast &amp; EaSy Commit And Rollback</strong> ，简单来说Fescar通过对本地RDBMS分支事务的协调来完成全局事务的推进，是工作应用层的中间件。优点明显，相对于XA模式是性能较好，相对于TCC等方式开发成本较低。</p>
<p>类似于XA，Fescar将角色分为TC、RM、TM，事务整体过程模型如下：</p>
<p><img src="https://camo.githubusercontent.com/6a31d57b4496e83af1a0bd76ede83657de2d9d34/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f343432303736372d343934613534643430326232643335342e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430" alt="Fescar事务过程"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID。</span><br><span class="line">2. XID 在微服务调用链路的上下文中传播。</span><br><span class="line">3. RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖。</span><br><span class="line">4. TM 向 TC 发起针对 XID 的全局提交或回滚决议。</span><br><span class="line">5. TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</span><br></pre></td></tr></table></figure>
<p>其中TC是单独的进程，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。TM RM则与应用程序工作在同一JVM进程。RM对JDBC数据源采用代理的方式对底层数据库做管理，利用语法解析，在执行事务保留快照，并生成undo log。大概的流程和模型划分就介绍到这里，下面开始对Fescar事务传播机制的分析。</p>
<h3 id="Fescar事务传播机制"><a href="#Fescar事务传播机制" class="headerlink" title="Fescar事务传播机制"></a>Fescar事务传播机制</h3><p>Fescar事务是怎么在微服务调用链中传播的呢？从前一节的事务流程我们可以看到，当开启一个全局事务的时候，TC会创建一个全局唯一的XID，XID 是一个全局事务的唯一标识。如果想要当前的分支事务纳入全局事务的管理，只需要将该XID绑定到当前的事务上下文中即可。我们根据不同的服务框架机制，将XID在链路中传递即可实现事务的传播。</p>
<p>RPC请求过程分为调用方与被调用方两部分，XID在请求与响应时做处理即可。调用方即请求方将当前事务上下文中的XID取出，利用RPC协议传递给被调用方，被调用方从请求中的将XID取出，并绑定到自己的事务上下文中，纳入全局事务。微服务框架一般都有相应的Filter机制，那么Spring Cloud用的是哪个机制呢，我们来分析下Spring Cloud与Fescar的整合过程。Code： <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-fescar" target="_blank" rel="noopener">spring-cloud-alibaba-fescar</a></p>
<h4 id="微服务被调用方"><a href="#微服务被调用方" class="headerlink" title="微服务被调用方"></a>微服务被调用方</h4><p>由于调用方的逻辑比较多一点，我们先分析被调用方的逻辑。针对于Spring Cloud项目，默认采用的RPC传输协议时HTTP协议，所以Fescar利用了HandlerInterceptor机制来对HTTP的请求做拦截。</p>
<p>HandlerInterceptor 是Spring提供的接口， 它有以下三个方法可以被覆写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Intercept the execution of a handler. Called after HandlerMapping determined</span></span><br><span class="line"><span class="comment"> * an appropriate handler object, but before HandlerAdapter invokes the handler.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Intercept the execution of a handler. Called after HandlerAdapter actually</span></span><br><span class="line"><span class="comment"> * invoked the handler, but before the DispatcherServlet renders the view.</span></span><br><span class="line"><span class="comment"> * Can expose additional model objects to the view via the given ModelAndView.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">		@Nullable ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Callback after completion of request processing, that is, after rendering</span></span><br><span class="line"><span class="comment"> * the view. Will be called on any outcome of handler execution, thus allows</span></span><br><span class="line"><span class="comment"> * for proper resource cleanup.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span></span><br><span class="line"><span class="function"><span class="params">		@Nullable Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据注释，我们可以很明确的看到各个方法的作用时间和常用用途。对于Fescar来讲，它重写了preHandle、afterCompletion方法。</p>
<p>FescarHandlerInterceptor 的作用是将Fescar 传递过来的 XID，绑定到本地事务的上下文中，并且在请求完成后清理相关资源。Fescar在FescarHandlerInterceptorConfiguration中配置了所有的url均进行拦截，对所有的请求过来均会执行该拦截器，进行XID的转换与事务绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaojing</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Fescar HandlerInterceptor, Convert Fescar information into</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.fescar.core.context.RootContext from http request's header in</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.HandlerInterceptor#preHandle(HttpServletRequest , HttpServletResponse , Object )&#125;,</span></span><br><span class="line"><span class="comment"> * And clean up Fescar information after servlet method invocation in</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.web.servlet.HandlerInterceptor#afterCompletion(HttpServletRequest, HttpServletResponse, Object, Exception)&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarHandlerInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory</span><br><span class="line">			.getLogger(FescarHandlerInterceptor.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">			Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		String xid = RootContext.getXID();</span><br><span class="line">		String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br><span class="line">		<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">			log.debug(<span class="string">"xid in RootContext &#123;&#125; xid in RpcContext &#123;&#125;"</span>, xid, rpcXid);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (xid == <span class="keyword">null</span> &amp;&amp; rpcXid != <span class="keyword">null</span>) &#123;</span><br><span class="line">			RootContext.bind(rpcXid);</span><br><span class="line">			<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">				log.debug(<span class="string">"bind &#123;&#125; to RootContext"</span>, rpcXid);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">			Object handler, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		String rpcXid = request.getHeader(RootContext.KEY_XID);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(rpcXid)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String unbindXid = RootContext.unbind();</span><br><span class="line">		<span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">			log.debug(<span class="string">"unbind &#123;&#125; from RootContext"</span>, unbindXid);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!rpcXid.equalsIgnoreCase(unbindXid)) &#123;</span><br><span class="line">			log.warn(<span class="string">"xid in change during RPC from &#123;&#125; to &#123;&#125;"</span>, rpcXid, unbindXid);</span><br><span class="line">			<span class="keyword">if</span> (unbindXid != <span class="keyword">null</span>) &#123;</span><br><span class="line">				RootContext.bind(unbindXid);</span><br><span class="line">				log.warn(<span class="string">"bind &#123;&#125; back to RootContext"</span>, unbindXid);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>preHandle在handler执行前被调用，xid为当前事务上下文已经绑定的全局事务id，rpcXid为请求通过HTTP Header传递过来的全局事务id。Fescar 在preHandle方法中判断如果当前事务上下文中没有XID，且rpcXid 不为空，那么就将rpcXid绑定到当前的事务上下文。这里的处理逻辑我理解这里也对应到了Fescar文档提到的传播机制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">对应到 Java EE 规范和 Spring 定义的事务传播属性，Fescar 的支持如下：</span><br><span class="line"></span><br><span class="line">PROPAGATION_REQUIRED： 默认支持</span><br><span class="line">PROPAGATION_SUPPORTS： 默认支持</span><br><span class="line">PROPAGATION_MANDATORY：应用通过 API 来实现</span><br><span class="line">PROPAGATION_REQUIRES_NEW：应用通过 API 来实现</span><br><span class="line">PROPAGATION_NOT_SUPPORTED：应用通过 API 来实现</span><br><span class="line">PROPAGATION_NEVER：应用通过 API 来实现</span><br><span class="line">PROPAGATION_NESTED：不支持</span><br></pre></td></tr></table></figure>
<p>afterCompletion在handler完成后被调用，该方法用来执行资源的清理动作。Fescar 通过RootContext.unbind() 方法对事务上下文涉及到的XID进行解绑。下面if中的逻辑是为了代码的健壮性考虑，如果遇到rpcXid和 unbindXid 不相等的情况，再将unbindXid反绑回去。</p>
<p>对于Spring Cloud来讲，默认采用的RPC方式是HTTP的方式，所以对被调用方来讲，它的请求拦截方式不用做任何区分，只需要从Header中将XID就可以取出绑定到自己的事务上下文中即可。但是对于调用方由于请求组件的多样化，包括熔断隔离机制，所以要区分不同的情况做处理，我们来分析一下。</p>
<h4 id="微服务调用方"><a href="#微服务调用方" class="headerlink" title="微服务调用方"></a>微服务调用方</h4><p>被调用方的机制非常明确简单，调用相对来讲就要复杂一点了。Fescar目前的代码将请求的情况分为RestTemplate、Feign、Feign+Hystrix，不同的组件通过Spring Boot的Auto Configuration来完成自动的配置，具体的配置类可以看spring.factories，下文也会基本上走一遍相关的配置类。</p>
<h5 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h5><p>先来看下如果调用方如果是是基于RestTemplate的请求，Fescar是怎么传递XID的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarRestTemplateInterceptor</span> <span class="keyword">implements</span> <span class="title">ClientHttpRequestInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">intercept</span><span class="params">(HttpRequest httpRequest, <span class="keyword">byte</span>[] bytes,</span></span></span><br><span class="line"><span class="function"><span class="params">			ClientHttpRequestExecution clientHttpRequestExecution)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		HttpRequestWrapper requestWrapper = <span class="keyword">new</span> HttpRequestWrapper(httpRequest);</span><br><span class="line"></span><br><span class="line">		String xid = RootContext.getXID();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.isEmpty(xid)) &#123;</span><br><span class="line">			requestWrapper.getHeaders().add(RootContext.KEY_XID, xid);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> clientHttpRequestExecution.execute(requestWrapper, bytes);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FescarRestTemplateInterceptor实现了ClientHttpRequestInterceptor接口的 intercept 方法，对调用的请求做了包装，在发送请求时将当前事务上下文的XID取出，放到了HTTP Header中。</p>
<p>FescarRestTemplateInterceptor配套了一个FescarRestTemplateAutoConfiguration，用于实现将FescarRestTemplateInterceptor配置到RestTemplate中去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarRestTemplateAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FescarRestTemplateInterceptor <span class="title">fescarRestTemplateInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FescarRestTemplateInterceptor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">	<span class="keyword">private</span> Collection&lt;RestTemplate&gt; restTemplates;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> FescarRestTemplateInterceptor fescarRestTemplateInterceptor;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostConstruct</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.restTemplates != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (RestTemplate restTemplate : restTemplates) &#123;</span><br><span class="line">				List&lt;ClientHttpRequestInterceptor&gt; interceptors = <span class="keyword">new</span> ArrayList&lt;ClientHttpRequestInterceptor&gt;(</span><br><span class="line">						restTemplate.getInterceptors());</span><br><span class="line">				interceptors.add(<span class="keyword">this</span>.fescarRestTemplateInterceptor);</span><br><span class="line">				restTemplate.setInterceptors(interceptors);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>init方法遍历所有的restTemplate，并将原来restTemplate钟的拦截器取出，增加fescarRestTemplateInterceptor后置入。</p>
<h5 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h5><p>那么再来看下Feign的相关代码，该包下面的类还是比较多的，先从AutoConfiguration入手</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(Client.class)</span><br><span class="line"><span class="meta">@AutoConfigureBefore</span>(FeignAutoConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarFeignClientAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(name = <span class="string">"com.netflix.hystrix.HystrixCommand"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"feign.hystrix.enabled"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line">	Feign.<span class="function">Builder <span class="title">feignHystrixBuilder</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> FescarHystrixFeignBuilder.builder(beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(name = <span class="string">"com.alibaba.csp.sentinel.SphU"</span>)</span><br><span class="line">	<span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"feign.sentinel.enabled"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line">	Feign.<span class="function">Builder <span class="title">feignSentinelBuilder</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> FescarSentinelFeignBuilder.builder(beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">	Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> FescarFeignBuilder.builder(beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignBeanPostProcessorConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function">FescarBeanPostProcessor <span class="title">fescarBeanPostProcessor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				FescarFeignObjectWrapper fescarFeignObjectWrapper)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FescarBeanPostProcessor(fescarFeignObjectWrapper);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function">FescarContextBeanPostProcessor <span class="title">fescarContextBeanPostProcessor</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">				BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FescarContextBeanPostProcessor(beanFactory);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function">FescarFeignObjectWrapper <span class="title">fescarFeignObjectWrapper</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FescarFeignObjectWrapper(beanFactory);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FescarFeignClientAutoConfiguration在存在Client.class时生效，且要求作用在FeignAutoConfiguration之前。</p>
<p>FescarFeignClientAutoConfiguration自定义了Feign.Builder，针对于feign.sentinel feign.hystrix 以及feign的情况做了适配，目的是自定义Feign中Client的实现为 FescarFeignClient。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HystrixFeign.builder().retryer(Retryer.NEVER_RETRY)</span><br><span class="line">      .client(<span class="keyword">new</span> FescarFeignClient(beanFactory))</span><br></pre></td></tr></table></figure>
<p>FescarFeignClient是对原来的Feign客户端代理增强：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarFeignClient</span> <span class="keyword">implements</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Client delegate;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> BeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">	FescarFeignClient(BeanFactory beanFactory) &#123;</span><br><span class="line">		<span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">		<span class="keyword">this</span>.delegate = <span class="keyword">new</span> Client.Default(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FescarFeignClient(BeanFactory beanFactory, Client delegate) &#123;</span><br><span class="line">		<span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">		<span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Response <span class="title">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		Request modifiedRequest = getModifyRequest(request);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.delegate.execute(modifiedRequest, options);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Request <span class="title">getModifyRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String xid = RootContext.getXID();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StringUtils.isEmpty(xid)) &#123;</span><br><span class="line">			<span class="keyword">return</span> request;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Map&lt;String, Collection&lt;String&gt;&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">		headers.putAll(request.headers());</span><br><span class="line"></span><br><span class="line">		List&lt;String&gt; fescarXid = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		fescarXid.add(xid);</span><br><span class="line">		headers.put(RootContext.KEY_XID, fescarXid);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> Request.create(request.method(), request.url(), headers, request.body(),</span><br><span class="line">				request.charset());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>方法相当明了，Feign的请求包装对应于被调用方的inteceptor的解析过程。Interceptor是从HTTP Header中将XID取出，那么Feign就是反向操作。上面的过程中我们可以看到，Fescar对原来的Request做了修改，它首先将XID从当前的事务上下文中取出，如果XID不为空的情况下，将XID放到了Header中。</p>
<p>FeignBeanPostProcessorConfiguration定义了3个bean，FescarContextBeanPostProcessor FescarBeanPostProcessor FescarFeignObjectWrapper。FescarContextBeanPostProcessor FescarBeanPostProcessor 实现了Spring BeanPostProcessor接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="function"><span class="keyword">default</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BeanPostProcessor的两个方法可以对Spring容器中的Bean做预处理，postProcessBeforeInitialization处理时机是初始化之前，postProcessAfterInitialization的处理时机是初始化之后，这2个方法的返回值可以是原先生成的实例bean，或者使用wrapper包装后的实例。</p>
<p>FescarContextBeanPostProcessor  将FeignContext 包装成 FescarFeignContext，FescarBeanPostProcessor  将FeignClient包装成FescarLoadBalancerFeignClient 返回。另外试想一下，对于开发者采用@Configuration 注解的自定义配置的Feign Client对象，那么Fescar的auto configuration是不是就处理不到了？这也是FescarContextBeanPostProcessor 存在的意义，可以在bean生成后做预处理增强。</p>
<p>对于FescarFeignObjectWrapper，我们重点关注下Wrapper方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">wrap</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Client &amp;&amp; !(bean <span class="keyword">instanceof</span> FescarFeignClient)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> LoadBalancerFeignClient) &#123;</span><br><span class="line">			LoadBalancerFeignClient client = ((LoadBalancerFeignClient) bean);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FescarLoadBalancerFeignClient(client.getDelegate(), factory(),</span><br><span class="line">					clientFactory(), <span class="keyword">this</span>.beanFactory);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FescarFeignClient(<span class="keyword">this</span>.beanFactory, (Client) bean);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Wrapper方法中，如果bean是LoadBalancerFeignClient的实例对象，那么首先通过client.getDelegate()方法将LoadBalancerFeignClient代理的实际Client对象取出后包装成FescarFeignClient，再生成LoadBalancerFeignClient的子类FescarLoadBalancerFeignClient对象。如果bean是Client的实例对象且不是FescarFeignClient LoadBalancerFeignClient，那么bean会直接包装生成 FescarFeignClient。</p>
<p>上面的流程设计还是比较巧妙的，首先自定义了Feign Builder的Bean，保证了Client均是经过增强后的FescarFeignClient 。再通过 BeanPostProcessor 对Spring 容器中的Bean做了一遍包装，保证容器内的Bean均是增强后FescarFeignClient 。</p>
<h5 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h5><p>下面我们再来看下Hystrix部分，为什么要单独把Hystrix拆出来看呢，而且Fescar代码也单独实现了个策略类。目前事务上下文RootContext的默认实现是基于ThreadLocal方式的ThreadLocalContextCore，也就是上下文其实是和线程绑定的。Hystrix本身有两种隔离状态的模式，基于信号量或者基于线程池进行隔离。Hystrix官方建议是采取线程池的方式来充分隔离，也是一般情况下在采用的模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread or Semaphore</span><br><span class="line">The default, and the recommended setting, is to run HystrixCommands using thread isolation (THREAD) and HystrixObservableCommands using semaphore isolation (SEMAPHORE).</span><br><span class="line"></span><br><span class="line">Commands executed in threads have an extra layer of protection against latencies beyond what network timeouts can offer.</span><br><span class="line"></span><br><span class="line">Generally the only time you should use semaphore isolation for HystrixCommands is when the call is so high volume (hundreds per second, per instance) that the overhead of separate threads is too high; this typically only applies to non-network calls.</span><br></pre></td></tr></table></figure>
<p>service层的业务代码和请求发出的线程肯定不是同一个，那么threadLocal的方式就没办法将XID传递给Hystrix的线程并传递给被调用方的。怎么处理这件事情呢，Hystrix提供了个机制让开发者去自定义并发策略，只需要 继承 HystrixConcurrencyStrategy重写wrapCallable方法即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarHystrixConcurrencyStrategy</span> <span class="keyword">extends</span> <span class="title">HystrixConcurrencyStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> HystrixConcurrencyStrategy delegate;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FescarHystrixConcurrencyStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.delegate = HystrixPlugins.getInstance().getConcurrencyStrategy();</span><br><span class="line">		HystrixPlugins.reset();</span><br><span class="line">		HystrixPlugins.getInstance().registerConcurrencyStrategy(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;K&gt; <span class="function">Callable&lt;K&gt; <span class="title">wrapCallable</span><span class="params">(Callable&lt;K&gt; c)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (c <span class="keyword">instanceof</span> FescarContextCallable) &#123;</span><br><span class="line">			<span class="keyword">return</span> c;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Callable&lt;K&gt; wrappedCallable;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.delegate != <span class="keyword">null</span>) &#123;</span><br><span class="line">			wrappedCallable = <span class="keyword">this</span>.delegate.wrapCallable(c);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			wrappedCallable = c;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (wrappedCallable <span class="keyword">instanceof</span> FescarContextCallable) &#123;</span><br><span class="line">			<span class="keyword">return</span> wrappedCallable;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FescarContextCallable&lt;&gt;(wrappedCallable);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FescarContextCallable</span>&lt;<span class="title">K</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;K&gt; actual;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> String xid;</span><br><span class="line"></span><br><span class="line">		FescarContextCallable(Callable&lt;K&gt; actual) &#123;</span><br><span class="line">			<span class="keyword">this</span>.actual = actual;</span><br><span class="line">			<span class="keyword">this</span>.xid = RootContext.getXID();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> K <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				RootContext.bind(xid);</span><br><span class="line">				<span class="keyword">return</span> actual.call();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				RootContext.unbind();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>本文只是介绍了下Fescar在Spring Cloud事务传递过程，更多更详细的内容请参考官方文档。总的来说，如果需要将Fescar融合到另外的三方RPC框架中，只需要找到对应的机制来传递全局事务的XID，将XID绑定在本地分支事务中即可。这两天对Fescar的了解下来，我的理解Fescar是一个工作在应用层，需要底层本地事务型数据库支撑，并对事务隔离级别等事务特性做了权衡的分布式事务中间件。</p>
<p>个人能力有限，不对的地方烦请指正。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="https://github.com/alibaba/fescar/wiki/%E6%A6%82%E8%A7%88" target="_blank" rel="noopener">Fescar官方概览</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          
            <a href="/tags/Distributed-Transaction/" rel="tag"># Distributed Transaction</a>
          
            <a href="/tags/Fescar/" rel="tag"># Fescar</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/11/spring-cloud-graceful-shutdown/" rel="next" title="Spring cloud优雅关闭的讨论">
                <i class="fa fa-chevron-left"></i> Spring cloud优雅关闭的讨论
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars1.githubusercontent.com/u/7402027?s=460&v=4"
                alt="ShukangGuo" />
            
              <p class="site-author-name" itemprop="name">ShukangGuo</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Fescar简要介绍"><span class="nav-number">1.</span> <span class="nav-text">Fescar简要介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fescar事务传播机制"><span class="nav-number">2.</span> <span class="nav-text">Fescar事务传播机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务被调用方"><span class="nav-number">2.1.</span> <span class="nav-text">微服务被调用方</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务调用方"><span class="nav-number">2.2.</span> <span class="nav-text">微服务调用方</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#RestTemplate"><span class="nav-number">2.2.1.</span> <span class="nav-text">RestTemplate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Feign"><span class="nav-number">2.2.2.</span> <span class="nav-text">Feign</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hystrix"><span class="nav-number">2.2.3.</span> <span class="nav-text">Hystrix</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结语"><span class="nav-number">3.</span> <span class="nav-text">结语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">4.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ShukangGuo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("6FAXp1fMO6heqYSnyUK8kDtF-gzGzoHsz", "qKueB30pIDCN48SB7Bta8Sjr");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
